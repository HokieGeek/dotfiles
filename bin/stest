#!/bin/bash

# Local vars
curr_dir=`pwd`
test_params=`ls -1tr *.stest | tail -1`
gdb_script="stest.gdb.$$"
default_exe="go"

if [ "$1" = "config" ]; then
	test_params="$curr_dir/`basename $curr_dir`.stest"

	cat > $test_params << CONFIG_DEFAULT
# STEST_BUILD_LOC=
# STEST_CMD=
	


#<gdb> run
CONFIG_DEFAULT

	exec vim +4 $test_params
fi

# Have to make sure we clean up
trap "[ -f ${gdb_script} ] && rm -rf ${gdb_script}" EXIT

# Deal with the arguments
[ "$1" == "clean" ] && clean=1 && shift || clean=0
[ "$1" = "gdb" -o "$1" = "ddd" ] && export STEST_DBG="$1 -x ${gdb_script} --args " && shift

# Load the test parameters
[ -f ${test_params} ] && . ${test_params}
if [ "${STEST_CMD:-"-"}" != "-" ]; then
	echo "STEST_CMD=${STEST_CMD}"
	STEST_EXE="`echo ${STEST_CMD} | sed 's/^\s*//g' | awk '{ print $1 }'`"
	STEST_EXE_ARGS=`echo ${STEST_CMD} | sed "s;${STEST_EXE}\s\+;;"`
fi

# In case we can't find an obvious executable
if [ "${STEST_EXE}" != "gdb" -a "${STEST_EXE}" != "ddd" -a ! -f "${STEST_EXE:-${default_exe}}" ]; then
	exe_loc_file="Makefile srcfiles.make"
	STEST_EXE=`awk -F= '/EXECUTABLE *=/ { print $2 }' ${exe_loc_file} | sed -e 's/^\s*//g' -e 's/(/{/g' -e 's/)/}/g'`
	STEST_EXE=${STEST_DBG:-}${STEST_EXE}
fi

# Build the gdb file (if one exists)
if [ ! -z "${STEST_DBG}" -a `grep -c "<gdb>" ${test_params}` -gt 0 ]; then
	awk '/#<gdb>/ { print $0 }' ${test_params} | sed 's/^#<gdb> //' > $gdb_script
fi

# Output our environment
echo STEST_BUILD_LOC=$STEST_BUILD_LOC
echo STEST_EXE="$STEST_EXE"
echo STEST_EXE_ARGS="$STEST_EXE_ARGS"

# Build at the specified locations
for d in ${STEST_BUILD_LOC:-"."}; do
	[ "$d" = "." ] && d=$curr_dir
	echo ">> $d"
	([ $clean -gt 0 ] && (make clean && make) || make) || exit 1
done

# Execute test
if [ -f "${STEST_EXE}" -o "${STEST_EXE}" == "gdb" -o "${STEST_EXE}" == "ddd" ]; then
	eval "${STEST_EXE:-"$curr_dir/${default_exe}"}" ${STEST_EXE_ARGS} $@
else
	exit 2
fi
