#!/bin/sh

if [ $# -gt 0 -a "$1" == "--help" ]; then
    echo "USAGE: git sublog [--help] <revision>"
    exit 1
fi
[ $# -le 0 ] && rev="HEAD~1" || rev=$1 

for x in `git diff ${rev}.. | egrep "(diff |-Subproject)" | awk '$1 ~ /diff/ { sub("b/", "", $NF); print $NF } $1 ~ /-Subproject/ { print $NF }' | sed '$!N;s/\n/:/'`; do
    p=`echo $x | cut -d: -f1`
    r=`echo $x | cut -d: -f2`
    echo -e "\033[35mSubmodule: ${p}"
    echo -e "\033[35mRevision: ${r}"
    echo -en '\033[0m'
    cd ${p}
    git --no-pager log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(cyan)<%an>%Creset' ${r}..
    cd ..
    echo -e "\n"
done | less -R
