#!/bin/bash

usage() {
    {
    [ $# -gt 0 ] && echo -e "${1}\n"
    echo "USAGE: `basename $0` [-g|-f] [-i] <EXPRESSION>"
    echo ""
    more << USAGE_INFO
       -g      - [DEFAULT] Greps the contents of all of the files in the directory (recursive)
       -f      - Searches for file and directory names (recursive)

       -i      - Makes any search case-insensitive
USAGE_INFO
    } >&2
}

expression=""
searchType="GREP"
caseInsensitive=0

# Parse the arguments
while [ $# -gt 0 ]; do
    case $1 in
    -f) searchType="FILES";;
    -g) searchType="GREP";;
    -i) caseInsensitive=1 ;;
    *) expression="${expression} $1";;
    esac
    shift
done

expression=`echo $expression | sed -e 's/^\s\*//g' -e 's/\s\*$//g'` # Trim
if [ -z "${expression}" ]; then
    usage "No search expression provided"
    exit 1
fi

doGrep() {
    grepformat="%f:%l:%c:%m"
    glob=""
    if `git rev-parse --is-inside-working-tree >/dev/null 2>&1`; then
        grepprg="git\\ grep\\ -n\\ --no-color"
        grepformat="%f:%l:%m"
    elif [ -x "`which ag 2>/dev/null`" ]; then
        grepprg="ag\\ --nogroup\\ --nocolor\\ --column"
    elif [ -x "`which ack 2>/dev/null`" ]; then
        grepprg="ack\\ --nogroup\\ --nocolor\\ --column"
    else
        grepprg="grep\\ -rnIH"
        grepformat="%f:%l:%m"
        glob="*"
    fi
    [ $caseInsensitive -gt 0 ] && opt_ci="-i" || opt_ci=""
    exec vim -c "set grepprg=${grepprg}" \
             -c "set grepformat=${grepformat}" \
             -c "set foldlevel=99" \
             -c "set cursorline" \
             -c "silent grep ${opt_ci} ${expression} ${glob}" \
             -c "if empty(getqflist())|qa|else|if len(getqflist()) > 1|copen|endif|endif" \
             -c "set nocursorline"
}

doFind() {
    [ $caseInsensitive -gt 0 ] && opt_ci="i" || opt_ci=""
    results=`mktemp`
    find . -${opt_ci}name "*${expression}*" -print | xargs file | sed 's/:/:1:/' > ${results}
    if [ -f "${results}" -a `wc -l ${results}` -gt 0 ]; then
        exec vim -c "cfile ${results}" \
                 -c "set errorformat=%f:%l:%m" \
                 -c "if empty(getqflist())|qa|else|if len(getqflist()) > 1|cwindow|endif|endif" \
                 -c "call delete('${results}')"
    fi
}

## Perform the search
case $searchType in
GREP) doGrep ;;
FILES) doFind ;;
esac
