#!/bin/sh

USAGE='s [-] SEARCH_TERM'
if [ $# -le 0 ]; then
	echo $USAGE
	exit
fi

#TODO: multiple words!
#TODO: uncompress tar/jar and search within its files

set -f # disable filename expansion
if [ $1 = "-" ]; then
	shift
	for file in `find . \! -name "*.jar" \! -name "*.tar" \! -name "*.class"`; do
		ext="."`echo $file | awk -F/ '{ print $NF }' | awk -F. '{ print $NF }'`
		if [ -x $file -o "${ext}" = ".class" ]; then
			if [ ! -d $file ]; then
			for hit in `strings $file | grep -n \"$@\" | sed 's/ /;AFP;/g'`; do
				echo $file":"`echo $hit | sed 's/;AFP;/ /g'`
			done
			fi
		else 
			#find . \! -name "*.jar" \! -name "*.tar" \! -name "*.class" | xargs fgrep -n $@
			#fgrep -n $@ ${file}
			for hit in `cat $file | grep -n \"$@\" | sed 's/ /;AFP;/g'`; do
				echo $file":"`echo $hit | sed 's/;AFP;/ /g'`
			done
		fi
	done
elif [ $1 = "+" ]; then
	shift
	set -x
	find . \! -name "*.jar" \! -name "*.tar" \! -name "*.class" | xargs fgrep -n "$@"

	exit

	for f in `find . \! -name "*.jar" \! -name "*.tar" \! -name "*.class"`; do
		fgrep -n "$@" $f
		#echo "fgrep -n \"$@\" $f"
	done
else
	find . \! -name "*.jar" \! -name "*.tar" \! -name "*.class" \! -name "*.o" \! -name "*.so" | xargs fgrep -n $1
fi
